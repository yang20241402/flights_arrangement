# 数据库统一管理说明

## 概述
已成功将IntegratedFlightSystem项目中所有分散的数据库连接统一到DatabaseManager类进行管理。

## 数据库配置

### 连接信息
- **主机**: localhost
- **端口**: 3306
- **用户名**: root
- **密码**: 208751

### 数据库列表
1. **flightdb** - 航班数据库
   - 存储航班信息、航班详情等
   - 使用类型: `DatabaseManager::FlightDB`

2. **planedbconn** - 用户数据库
   - 存储用户登录信息、注册信息等
   - 使用类型: `DatabaseManager::PlaneDB`

3. **personcenterdatabase** - 个人中心数据库
   - 存储订单信息、乘客信息等
   - 使用类型: `DatabaseManager::PersonCenterDB`

## 主要改动

### 1. 新增文件
- `database/databasemanager.h` - 数据库管理类头文件
- `database/databasemanager.cpp` - 数据库管理类实现
- `database/README.md` - 使用说明文档

### 2. 修改的文件

#### 登录模块
- `login/widget.cpp` - 移除QODBC连接，使用统一管理器
- `login/widget.h` - 移除db成员变量
- `login/form.cpp` - 使用统一数据库管理器
- `login/form.h` - 移除db成员变量

#### 航班模块
- `flight/flightquerywidget.cpp` - 移除独立连接，使用统一管理器
- `flight/flightdetailwidget.cpp` - 移除独立连接，使用统一管理器
- `flight/flightdetailwidget.h` - 移除m_db成员变量和initDB方法

#### 个人中心模块
- `person/passengerdialog.cpp` - 移除QODBC连接，使用统一管理器
- `person/passengerdialog.h` - 移除m_db成员变量和initDatabase方法
- `person/myorderdialog.cpp` - 移除QODBC连接，使用统一管理器

#### 主程序
- `main.cpp` - 在程序启动时初始化所有数据库连接
- `CMakeLists.txt` - 添加数据库管理模块

## 使用方法

### 基本用法
```cpp
// 1. 获取数据库管理器实例（单例）
DatabaseManager* dbManager = DatabaseManager::instance();

// 2. 创建查询（推荐方式）
QSqlQuery query = dbManager->createQuery(DatabaseManager::FlightDB);
query.prepare("SELECT * FROM flights WHERE id = ?");
query.addBindValue(flightId);
query.exec();

// 3. 获取数据库连接（如需要）
QSqlDatabase db = dbManager->getDatabase(DatabaseManager::PlaneDB);

// 4. 检查连接状态
if (dbManager->isDatabaseConnected(DatabaseManager::PersonCenterDB)) {
    // 数据库已连接
}
```

### 示例代码

#### 用户登录
```cpp
DatabaseManager* dbManager = DatabaseManager::instance();
QSqlQuery query = dbManager->createQuery(DatabaseManager::PlaneDB);
query.prepare("SELECT * FROM uesr_info1 WHERE username = ?");
query.addBindValue(username);
if (query.exec() && query.next()) {
    // 登录成功
}
```

#### 航班查询
```cpp
DatabaseManager* dbManager = DatabaseManager::instance();
QSqlQuery query = dbManager->createQuery(DatabaseManager::FlightDB);
query.prepare("SELECT * FROM flights WHERE 出发城市 = ?");
query.addBindValue(city);
query.exec();
```

#### 订单管理
```cpp
DatabaseManager* dbManager = DatabaseManager::instance();
QSqlQuery query = dbManager->createQuery(DatabaseManager::PersonCenterDB);
query.prepare("SELECT * FROM `order` WHERE user_id = ?");
query.addBindValue(userId);
query.exec();
```

## 优势

### 1. 统一管理
- 所有数据库连接在程序启动时统一初始化
- 避免重复创建和销毁连接
- 便于维护和修改配置

### 2. 连接复用
- 使用单例模式，全局共享数据库连接
- 减少资源消耗
- 提高性能

### 3. 错误处理
- 统一的错误处理机制
- 自动重连功能
- 详细的错误日志

### 4. 代码简化
- 移除各模块中重复的数据库连接代码
- 统一的API接口
- 更清晰的代码结构

## 注意事项

1. **程序启动**: 数据库在main.cpp中初始化，如果连接失败程序会提示并退出
2. **字符编码**: 已统一设置为UTF-8 (utf8mb4)
3. **连接池**: 使用Qt的连接名机制管理多个数据库连接
4. **线程安全**: 使用QMutex保证单例模式的线程安全

## 后续优化建议

1. 将数据库配置信息移到配置文件中
2. 添加连接池管理
3. 实现数据库操作的事务支持
4. 添加更详细的日志记录
5. 考虑添加数据库迁移工具

## 测试建议

1. 测试程序启动时数据库连接是否成功
2. 测试各模块的数据库操作功能
3. 测试数据库连接断开后的重连机制
4. 测试并发访问情况下的稳定性
